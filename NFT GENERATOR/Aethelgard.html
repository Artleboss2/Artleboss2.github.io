<!DOCTYPE html>
<html lang="fr" class="no-js">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aethelgard NFT | AI Generative Engine 4.5.2-PRO</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=JetBrains+Mono:wght@300;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        :root {
            --athel-bg: #000000;
            --athel-surface: #0a0a0a;
            --athel-primary: #ffffff;
            --athel-secondary: #86868b;
            --athel-accent: #0071e3;
            --athel-border: rgba(255, 255, 255, 0.08);
            --athel-font-sans: 'Inter', sans-serif;
            --athel-font-mono: 'JetBrains Mono', monospace;
            --athel-ease: cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--athel-bg); color: var(--athel-primary); font-family: var(--athel-font-sans); overflow-x: hidden; -webkit-font-smoothing: antialiased; }

        /* --- NAVIGATION --- */
        .athel-nav {
            position: fixed; top: 0; width: 100%; height: 52px; z-index: 1000;
            border-bottom: 1px solid var(--athel-border); backdrop-filter: blur(20px); background: rgba(0, 0, 0, 0.7);
        }
        .athel-nav__container {
            max-width: 1440px; margin: 0 auto; height: 100%;
            padding: 0 40px; display: flex; justify-content: space-between; align-items: center;
        }
        .athel-nav__logo { font-weight: 600; font-size: 14px; letter-spacing: 1px; cursor: pointer; }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-link { font-size: 11px; color: var(--athel-secondary); text-decoration: none; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: 0.3s; }
        .nav-link:hover { color: white; }

        /* --- PAGES / VIEWS --- */
        .view-section { display: none; min-height: 100vh; padding-top: 100px; opacity: 0; transition: opacity 0.4s ease; }
        .view-active { display: block; opacity: 1; }
        .studio-grid { display: grid; grid-template-columns: 1fr 380px; gap: 80px; max-width: 1440px; margin: 0 auto; padding: 0 40px; }

        /* --- AUTH PAGES --- */
        .auth-container { max-width: 400px; margin: 5vh auto; padding: 40px; background: var(--athel-surface); border: 1px solid var(--athel-border); border-radius: 24px; text-align: center; }
        .auth-container h2 { margin-bottom: 30px; font-weight: 300; letter-spacing: -1px; font-size: 28px; }
        .auth-input { width: 100%; padding: 14px; background: #161617; border: 1px solid var(--athel-border); border-radius: 12px; color: white; margin-bottom: 12px; font-family: var(--athel-font-mono); outline: none; }
        
        /* --- STUDIO --- */
        .athel-studio__preview { background: #050505; border-radius: 24px; border: 1px solid var(--athel-border); aspect-ratio: 1; position: relative; overflow: hidden; }
        canvas { width: 100% !important; height: 100% !important; display: block; }

        /* --- GALLERY --- */
        .gallery-section { max-width: 1440px; margin: 80px auto; padding: 0 40px 100px; border-top: 1px solid var(--athel-border); padding-top: 60px; }
        .gallery-title { font-size: 10px; color: var(--athel-secondary); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 30px; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .nft-card { background: var(--athel-surface); border: 1px solid var(--athel-border); padding: 15px; border-radius: 16px; font-family: var(--athel-font-mono); font-size: 10px; }
        .nft-card span { color: var(--athel-secondary); display: block; margin-top: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* --- UI --- */
        .athel-btn { border: none; padding: 16px; border-radius: 12px; font-size: 13px; cursor: pointer; transition: 0.4s var(--athel-ease); font-family: inherit; width: 100%; margin-bottom: 10px; background: white; color: black; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .athel-btn--outline { background: transparent; border: 1px solid var(--athel-border); color: white; }
        .hash-tag { position: absolute; top: 24px; right: 24px; font-family: var(--athel-font-mono); font-size: 10px; color: var(--athel-secondary); background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--athel-border); }
        .error-msg { color: #ff3b30; font-size: 11px; margin-top: 10px; font-family: var(--athel-font-mono); min-height: 1.2em; }

        .athel-loader { position: fixed; inset: 0; z-index: 10000; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .loader-svg { width: 80px; height: 80px; stroke: white; fill: none; stroke-width: 2; stroke-dasharray: 200; stroke-dashoffset: 200; animation: dash 2s infinite; }
        @keyframes dash { to { stroke-dashoffset: 0; } }
    </style>
</head>
<body>

    <div id="loader" class="athel-loader">
        <svg class="loader-svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40"/></svg>
        <div style="margin-top:20px; font-size:9px; letter-spacing:3px; color:var(--athel-secondary)">CORE LOADING...</div>
    </div>

    <nav class="athel-nav">
        <div class="athel-nav__container">
            <div class="athel-nav__logo" onclick="showView('view-studio')">AETHELGARD</div>
            <div class="nav-links" id="nav-auth-group">
                <span class="nav-link" onclick="showView('view-login')">Connexion</span>
                <span class="nav-link" onclick="showView('view-signup')" style="color:white; border:1px solid var(--athel-border); padding:5px 12px; border-radius:20px">S'inscrire</span>
            </div>
            <div id="nav-user-group" style="display:none;">
                <span id="user-display" class="nav-link" style="color:white">--</span>
                <span class="nav-link" id="btn-logout" style="margin-left:15px; opacity:0.5; font-size:10px">LOGOUT</span>
            </div>
        </div>
    </nav>

    <main id="view-studio" class="view-section view-active">
        <div class="studio-grid">
            <section>
                <div class="athel-studio__preview">
                    <canvas id="art-canvas"></canvas>
                    <div id="art-hash" class="hash-tag">0x...</div>
                </div>
            </section>
            <aside>
                <div style="margin-bottom:40px">
                    <h3 style="font-size:10px; color:var(--athel-secondary); text-transform:uppercase; letter-spacing:2px; margin-bottom:20px">Générateur Chromatique</h3>
                    <label style="font-size:11px; color:var(--athel-secondary)">Complexité</label>
                    <input type="range" id="complexity" min="20" max="600" value="200" style="width:100%; margin: 10px 0 20px;">
                    <label style="font-size:11px; color:var(--athel-secondary)">Intensité Chroma</label>
                    <input type="range" id="chroma" min="0" max="100" value="85" style="width:100%; margin: 10px 0;">
                </div>
                <button id="btn-generate" class="athel-btn">Minter un Artifact</button>
                <button id="btn-save" class="athel-btn athel-btn--outline">Synchroniser (Cloud)</button>
            </aside>
        </div>

        <section class="gallery-section">
            <h2 class="gallery-title">Archives du Cloud (NFTS)</h2>
            <div id="gallery-container" class="gallery-grid">
                </div>
        </section>
    </main>

    <div id="view-login" class="view-section">
        <div class="auth-container">
            <h2>Accès Node</h2>
            <input type="email" id="login-email" class="auth-input" placeholder="Email">
            <input type="password" id="login-pass" class="auth-input" placeholder="Mot de passe">
            <button id="do-login" class="athel-btn">Se connecter</button>
            <div style="margin:20px 0; font-size:10px; color:var(--athel-secondary); letter-spacing:2px">PASSERELLE SOCIALE</div>
            <button id="btn-google" class="athel-btn athel-btn--outline">Google Gateway</button>
            <button id="btn-github" class="athel-btn athel-btn--outline">GitHub Node</button>
            <p id="login-error" class="error-msg"></p>
        </div>
    </div>

    <div id="view-signup" class="view-section">
        <div class="auth-container">
            <h2>Nouveau Nœud</h2>
            <input type="email" id="signup-email" class="auth-input" placeholder="Email">
            <input type="password" id="signup-pass" class="auth-input" placeholder="Mot de passe">
            <button id="do-signup" class="athel-btn">Créer le compte</button>
            <p id="signup-error" class="error-msg"></p>
        </div>
    </div>

    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js"
      }
    }
    </script>

    <script type="module">
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithRedirect, getRedirectResult, GoogleAuthProvider, GithubAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'firebase/auth';
        import { getDatabase, ref, push, set, onValue, serverTimestamp, limitToLast, query } from 'firebase/database';

        const firebaseConfig = {
            apiKey: "AIzaSyAqDntQdOek29SF2Zi0V3SR9kB_KjObMmA",
            authDomain: "nft-generator-3a169.firebaseapp.com",
            databaseURL: "https://nft-generator-3a169-default-rtdb.firebaseio.com",
            projectId: "nft-generator-3a169",
            storageBucket: "nft-generator-3a169.firebasestorage.app"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- NAVIGATION & VIEWS ---
        window.showView = (viewId) => {
            document.querySelectorAll('.view-section').forEach(v => {
                v.classList.remove('view-active');
                v.style.display = 'none';
            });
            const target = document.getElementById(viewId);
            target.style.display = 'block';
            requestAnimationFrame(() => target.classList.add('view-active'));
        };

        // --- AUTH & DATABASE (Fichiers COMPTES) ---
        onAuthStateChanged(auth, async (user) => {
            const authGroup = document.getElementById('nav-auth-group');
            const userGroup = document.getElementById('nav-user-group');
            
            if (user) {
                authGroup.style.display = 'none';
                userGroup.style.display = 'flex';
                document.getElementById('user-display').innerText = (user.displayName || user.email.split('@')[0]).toUpperCase();

                // FICHIER COMPTE : Enregistrement auto
                await set(ref(db, 'COMPTES/' + user.uid), {
                    username: user.displayName || user.email.split('@')[0],
                    email: user.email,
                    lastActive: serverTimestamp()
                });

                showView('view-studio');
                loadGallery();
            } else {
                authGroup.style.display = 'flex';
                userGroup.style.display = 'none';
                if(!document.getElementById('view-signup').classList.contains('view-active')) showView('view-login');
            }
            gsap.to("#loader", {opacity: 0, duration: 0.5, onComplete: () => document.getElementById('loader').style.display='none'});
        });

        // SOCIAL HANDLERS
        getRedirectResult(auth).catch(e => console.error("Social Error", e));
        document.getElementById('btn-google').onclick = () => signInWithRedirect(auth, new GoogleAuthProvider());
        document.getElementById('btn-github').onclick = () => signInWithRedirect(auth, new GithubAuthProvider());
        document.getElementById('btn-logout').onclick = () => signOut(auth);

        // --- ENGINE ---
        class AethelEngine {
            constructor() {
                this.canvas = document.getElementById('art-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = 1600; this.canvas.height = 1600;
                this.complexity = 200; this.chroma = 85;
                this.generateNewHash();
            }
            generateNewHash() {
                this.currentHash = '0x' + Math.random().toString(16).slice(2, 18).toUpperCase();
                this.seed = parseInt(this.currentHash.substring(2, 10), 16);
                document.getElementById('art-hash').innerText = this.currentHash;
            }
            generate() {
                let s = this.seed;
                const rnd = () => { s = (s * 9301 + 49297) % 233280; return s / 233280; };
                this.ctx.fillStyle = '#050505';
                this.ctx.fillRect(0, 0, 1600, 1600);
                for(let i = 0; i < this.complexity; i++) {
                    this.ctx.save();
                    this.ctx.translate(800, 800);
                    this.ctx.rotate(rnd() * Math.PI * 2);
                    const hue = rnd() * 360;
                    const color = `hsl(${hue}, ${this.chroma}%, 55%)`;
                    this.ctx.strokeStyle = color;
                    this.ctx.lineWidth = rnd() * 2 + 0.5;
                    this.ctx.globalAlpha = rnd() * 0.6 + 0.1;
                    this.ctx.beginPath();
                    this.ctx.moveTo(rnd() * 300, 0);
                    this.ctx.lineTo(rnd() * 600 + 100, (rnd() - 0.5) * 200);
                    this.ctx.stroke();
                    this.ctx.restore();
                }
            }
        }

        const engine = new AethelEngine();
        engine.generate();
        document.getElementById('btn-generate').onclick = () => { engine.generateNewHash(); engine.generate(); };
        document.getElementById('complexity').oninput = (e) => { engine.complexity = e.target.value; engine.generate(); };
        document.getElementById('chroma').oninput = (e) => { engine.chroma = e.target.value; engine.generate(); };

        // --- FICHIER NFT : Sauvegarde ---
        document.getElementById('btn-save').onclick = async () => {
            if(!auth.currentUser) return showView('view-login');
            const btn = document.getElementById('btn-save');
            btn.innerText = "Syncing...";
            try {
                // Création du fichier NFT lié à l'UID du compte
                await set(push(ref(db, "NFTS")), {
                    hash: engine.currentHash,
                    creatorId: auth.currentUser.uid,
                    creatorEmail: auth.currentUser.email,
                    timestamp: serverTimestamp()
                });
                btn.innerText = "Artifact Cloud Sync !";
            } catch(e) { btn.innerText = "Error Syncing"; }
            setTimeout(() => btn.innerText = "Synchroniser (Cloud)", 2000);
        };

        // --- GALERIE : Chargement en temps réel ---
        function loadGallery() {
            const galleryRef = query(ref(db, "NFTS"), limitToLast(12));
            onValue(galleryRef, (snapshot) => {
                const container = document.getElementById('gallery-container');
                container.innerHTML = "";
                snapshot.forEach((child) => {
                    const data = child.val();
                    const card = document.createElement('div');
                    card.className = "nft-card";
                    card.innerHTML = `
                        <div style="color:white">${data.hash}</div>
                        <span>Par: ${data.creatorEmail}</span>
                    `;
                    container.prepend(card);
                });
            });
        }
    </script>
</body>
</html>
